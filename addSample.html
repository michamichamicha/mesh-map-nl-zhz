<!DOCTYPE html>
<html lang="en">

<head>
  <title>Add Sample</title>
  <link rel="stylesheet" type="text/css" href="content/forms.css" />
</head>

<body>
  <div>
    <div class="form-item">
      <label for="loc">Location:</label>
      <input type="text" id="loc" name="loc" placeholder="(LAT) (LON)">
    </div>
    <div class="form-item">
      <label for="path">Path:</label>
      <input type="text" id="path" name="path">
    </div>
    <div class="form-item">
      <label for="snr">SNR:</label>
      <input type="text" id="snr" name="snr">
    </div>
    <div class="form-item">
      <label for="rssi">RSSI:</label>
      <input type="text" id="rssi" name="rssi">
    </div>
    <div class="form-item">
      <label for="observed">Observed:</label>
      <input type="checkbox" id="observed" name="observed">
    </div>
    <div class="form-item">
      <button tabindex="0" id="submit" name="submit">Submit</button>
    </div>
  </div>
  <div id="status">
  </div>

  <script type="module">
    import { parseLocation } from '/content/shared.js'
    const $ = (id) => document.getElementById(id);
    const locTxt = $('loc');
    const pathTxt = $('path');
    const snrTxt = $('snr');
    const rssiTxt = $('rssi');
    const observedCB = $('observed');
    const statusDiv = $('status');

    function setStatus(msg) {
      msg = msg ?? "";
      statusDiv.innerText = msg
      if (msg !== "") {
        setTimeout(setStatus, 3000);
      }
    }

    function clearForm() {
      locTxt.value = '';
      pathTxt.value = '';
      snrTxt.value = '';
      rssiTxt.value = '';
      observedCB.checked = false;
    }

    async function putSample() {
      const [latVal, lonVal] = locTxt.value.split(/\s*,?\s+/)
      const [lat, lon] = parseLocation(latVal, lonVal);
      const pathVal = pathTxt.value;
      const snrVal = snrTxt.value;
      const rssiVal = rssiTxt.value;
      const payload = {
        lat: lat,
        lon: lon,
        path: pathVal !== "" ? pathVal.split(',') : [],
        snr: snrVal !== "" ? Number(snrVal) : null,
        rssi: rssiVal !== "" ? Number(rssiVal) : null,
        observed: observedCB.checked
      };

      setStatus('');

      const resp = await fetch('/put-sample', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        setStatus('HTTP error ' + resp.status);
      } else {
        setStatus(`Sample saved! ${[lat, lon]}`);
        clearForm();
      }
    }

    async function tryPutSample() {
      try {
        await putSample();
      } catch (error) {
        setStatus(error);
      }
    }

    $('submit').addEventListener('click', tryPutSample);
  </script>
</body>

</html>
